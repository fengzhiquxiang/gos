     1                                  ; boot.asm
     2                                  
     3                                  BaseOfLoaderPhyAddr equ 0x07c00
     4                                  
     5                                  [SECTION .text]
     6                                  org  0x7c00
     7                                  
     8                                  start:
     9 00000000 31C0                      xor ax, ax      ;mov ax, 0x0
    10 00000002 8ED8                      mov ds, ax
    11 00000004 8EC0                      mov es, ax 
    12 00000006 8ED0                      mov ss, ax 
    13                                  
    14 00000008 B8007C                    mov ax, BaseOfLoaderPhyAddr
    15 0000000B 89C4                      mov sp, ax   
    16                                  
    17                                    ; 清屏
    18 0000000D B80006                    mov   ax, 0600h      ; AH = 6,  AL = 0h
    19 00000010 BB0007                    mov   bx, 0700h      ; 黑底白字(BL = 07h)
    20 00000013 B90000                    mov   cx, 0       ; 左上角: (0, 0)
    21 00000016 BA4F18                    mov   dx, 0184fh     ; 右下角: (80, 50)
    22 00000019 CD10                      int   10h         ; int 10h
    23                                  
    24 0000001B E84600                    call read_fd
    25                                  
    26                                    ; 下面准备跳入保护模式 -------------------------------------------
    27                                    ; 关中断
    28 0000001E FA                        cli
    29                                    ; 加载 GDTR
    30 0000001F 0F0116[5E00]              lgdt  [GdtPtr]
    31                                    ; 打开地址线A20
    32 00000024 E492                      in al, 92h
    33 00000026 0C02                      or al, 00000010b
    34 00000028 E692                      out   92h, al
    35                                  
    36                                    ; 准备切换到保护模式
    37 0000002A 0F20C0                    mov   eax, cr0
    38 0000002D 6683C801                  or eax, 1
    39 00000031 0F22C0                    mov   cr0, eax
    40                                  
    41                                    ; 真正进入保护模式
    42 00000034 66EA007E00000800          jmp   dword SelectorFlatC:0x7e00
    43                                  
    44                                  
    45                                  hang:
    46 0000003C EBFE                      jmp hang
    47                                  
    48                                  %include "pm.mac"
    49                              <1> 
    50                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    51                              <1> ;                               pm.inc
    52                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    53                              <1> ;                                                     Forrest Yu, 2005
    54                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    55                              <1> 
    56                              <1> 
    57                              <1> ; 描述符图示
    58                              <1> 
    59                              <1> ; 图示一
    60                              <1> ;
    61                              <1> ;  ------ ┏━━┳━━┓高地址
    62                              <1> ;         ┃ 7  ┃ 段 ┃
    63                              <1> ;         ┣━━┫    ┃
    64                              <1> ;                  基
    65                              <1> ;  字节 7 ┆    ┆    ┆
    66                              <1> ;                  址
    67                              <1> ;         ┣━━┫ ② ┃
    68                              <1> ;         ┃ 0  ┃    ┃
    69                              <1> ;  ------ ┣━━╋━━┫
    70                              <1> ;         ┃ 7  ┃ G  ┃
    71                              <1> ;         ┣━━╉──┨
    72                              <1> ;         ┃ 6  ┃ D  ┃
    73                              <1> ;         ┣━━╉──┨
    74                              <1> ;         ┃ 5  ┃ 0  ┃
    75                              <1> ;         ┣━━╉──┨
    76                              <1> ;         ┃ 4  ┃ AVL┃
    77                              <1> ;  字节 6 ┣━━╉──┨
    78                              <1> ;         ┃ 3  ┃    ┃
    79                              <1> ;         ┣━━┫ 段 ┃
    80                              <1> ;         ┃ 2  ┃ 界 ┃
    81                              <1> ;         ┣━━┫ 限 ┃
    82                              <1> ;         ┃ 1  ┃    ┃
    83                              <1> ;         ┣━━┫ ② ┃
    84                              <1> ;         ┃ 0  ┃    ┃
    85                              <1> ;  ------ ┣━━╋━━┫
    86                              <1> ;         ┃ 7  ┃ P  ┃
    87                              <1> ;         ┣━━╉──┨
    88                              <1> ;         ┃ 6  ┃    ┃
    89                              <1> ;         ┣━━┫ DPL┃
    90                              <1> ;         ┃ 5  ┃    ┃
    91                              <1> ;         ┣━━╉──┨
    92                              <1> ;         ┃ 4  ┃ S  ┃
    93                              <1> ;  字节 5 ┣━━╉──┨
    94                              <1> ;         ┃ 3  ┃    ┃
    95                              <1> ;         ┣━━┫ T  ┃
    96                              <1> ;         ┃ 2  ┃ Y  ┃
    97                              <1> ;         ┣━━┫ P  ┃
    98                              <1> ;         ┃ 1  ┃ E  ┃
    99                              <1> ;         ┣━━┫    ┃
   100                              <1> ;         ┃ 0  ┃    ┃
   101                              <1> ;  ------ ┣━━╋━━┫
   102                              <1> ;         ┃ 23 ┃    ┃
   103                              <1> ;         ┣━━┫    ┃
   104                              <1> ;         ┃ 22 ┃    ┃
   105                              <1> ;         ┣━━┫ 段 ┃
   106                              <1> ;
   107                              <1> ;   字节  ┆    ┆ 基 ┆
   108                              <1> ; 2, 3, 4
   109                              <1> ;         ┣━━┫ 址 ┃
   110                              <1> ;         ┃ 1  ┃ ① ┃
   111                              <1> ;         ┣━━┫    ┃
   112                              <1> ;         ┃ 0  ┃    ┃
   113                              <1> ;  ------ ┣━━╋━━┫
   114                              <1> ;         ┃ 15 ┃    ┃
   115                              <1> ;         ┣━━┫    ┃
   116                              <1> ;         ┃ 14 ┃    ┃
   117                              <1> ;         ┣━━┫ 段 ┃
   118                              <1> ;
   119                              <1> ; 字节 0,1┆    ┆ 界 ┆
   120                              <1> ;
   121                              <1> ;         ┣━━┫ 限 ┃
   122                              <1> ;         ┃ 1  ┃ ① ┃
   123                              <1> ;         ┣━━┫    ┃
   124                              <1> ;         ┃ 0  ┃    ┃
   125                              <1> ;  ------ ┗━━┻━━┛低地址
   126                              <1> ;
   127                              <1> 
   128                              <1> 
   129                              <1> ; 图示二
   130                              <1> 
   131                              <1> ; 高地址………………………………………………………………………低地址
   132                              <1> 
   133                              <1> ; |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0    |
   134                              <1> ; |7654321076543210765432107654321076543210765432107654321076543210|	<- 共 8 字节
   135                              <1> ; |--------========--------========--------========--------========|
   136                              <1> ; ┏━━━┳━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓
   137                              <1> ; ┃31..24┃   (见下图)   ┃     段基址(23..0)    ┃ 段界限(15..0)┃
   138                              <1> ; ┃      ┃              ┃                      ┃              ┃
   139                              <1> ; ┃ 基址2┃③│②│    ①┃基址1b│   基址1a     ┃    段界限1   ┃
   140                              <1> ; ┣━━━╋━━━┳━━━╋━━━━━━━━━━━╋━━━━━━━┫
   141                              <1> ; ┃   %6 ┃  %5  ┃  %4  ┃  %3  ┃     %2       ┃       %1     ┃
   142                              <1> ; ┗━━━┻━━━┻━━━┻━━━┻━━━━━━━┻━━━━━━━┛
   143                              <1> ;         │                \_________
   144                              <1> ;         │                          \__________________
   145                              <1> ;         │                                             \________________________________________________
   146                              <1> ;         │                                                                                              ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━
   147                              <1> ;         ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   148                              <1> ;         ┣━━╋━━╋━━╋━━╋━━┻━━┻━━┻━━╋━━╋━━┻━━╋━━╋━━┻━━┻━━┻━━┫
   149                              <1> ;         ┃ G  ┃ D  ┃ 0  ┃ AVL┃   段界限 2 (19..16)  ┃  P ┃   DPL    ┃ S  ┃       TYPE           ┃
   150                              <1> ;         ┣━━┻━━┻━━┻━━╋━━━━━━━━━━━╋━━┻━━━━━┻━━┻━━━━━━━━━━━┫
   151                              <1> ;         ┃      ③: 属性 2      ┃    ②: 段界限 2      ┃                   ①: 属性1                  ┃
   152                              <1> ;         ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━┛
   153                              <1> ;       高地址                                                                                          低地址
   154                              <1> ;
   155                              <1> ;
   156                              <1> 
   157                              <1> ; 说明:
   158                              <1> ;
   159                              <1> ; (1) P:    存在(Present)位。
   160                              <1> ;		P=1 表示描述符对地址转换是有效的，或者说该描述符所描述的段存在，即在内存中；
   161                              <1> ;		P=0 表示描述符对地址转换无效，即该段不存在。使用该描述符进行内存访问时会引起异常。
   162                              <1> ;
   163                              <1> ; (2) DPL:  表示描述符特权级(Descriptor Privilege level)，共2位。它规定了所描述段的特权级，用于特权检查，以决定对该段能否访问。 
   164                              <1> ;
   165                              <1> ; (3) S:   说明描述符的类型。
   166                              <1> ;		对于存储段描述符而言，S=1，以区别与系统段描述符和门描述符(S=0)。 
   167                              <1> ;
   168                              <1> ; (4) TYPE: 说明存储段描述符所描述的存储段的具体属性。
   169                              <1> ;
   170                              <1> ;		 
   171                              <1> ;	数据段类型	类型值		说明
   172                              <1> ;			----------------------------------
   173                              <1> ;			0		只读 
   174                              <1> ;			1		只读、已访问 
   175                              <1> ;			2		读/写 
   176                              <1> ;			3		读/写、已访问 
   177                              <1> ;			4		只读、向下扩展 
   178                              <1> ;			5		只读、向下扩展、已访问 
   179                              <1> ;			6		读/写、向下扩展 
   180                              <1> ;			7		读/写、向下扩展、已访问 
   181                              <1> ;
   182                              <1> ;		
   183                              <1> ;			类型值		说明
   184                              <1> ;	代码段类型	----------------------------------
   185                              <1> ;			8		只执行 
   186                              <1> ;			9		只执行、已访问 
   187                              <1> ;			A		执行/读 
   188                              <1> ;			B		执行/读、已访问 
   189                              <1> ;			C		只执行、一致码段 
   190                              <1> ;			D		只执行、一致码段、已访问 
   191                              <1> ;			E		执行/读、一致码段 
   192                              <1> ;			F		执行/读、一致码段、已访问 
   193                              <1> ;
   194                              <1> ;		
   195                              <1> ;	系统段类型	类型编码	说明
   196                              <1> ;			----------------------------------
   197                              <1> ;			0		<未定义>
   198                              <1> ;			1		可用286TSS
   199                              <1> ;			2		LDT
   200                              <1> ;			3		忙的286TSS
   201                              <1> ;			4		286调用门
   202                              <1> ;			5		任务门
   203                              <1> ;			6		286中断门
   204                              <1> ;			7		286陷阱门
   205                              <1> ;			8		未定义
   206                              <1> ;			9		可用386TSS
   207                              <1> ;			A		<未定义>
   208                              <1> ;			B		忙的386TSS
   209                              <1> ;			C		386调用门
   210                              <1> ;			D		<未定义>
   211                              <1> ;			E		386中断门
   212                              <1> ;			F		386陷阱门
   213                              <1> ;
   214                              <1> ; (5) G:    段界限粒度(Granularity)位。
   215                              <1> ;		G=0 表示界限粒度为字节；
   216                              <1> ;		G=1 表示界限粒度为4K 字节。
   217                              <1> ;           注意，界限粒度只对段界限有效，对段基地址无效，段基地址总是以字节为单位。 
   218                              <1> ;
   219                              <1> ; (6) D:    D位是一个很特殊的位，在描述可执行段、向下扩展数据段或由SS寄存器寻址的段(通常是堆栈段)的三种描述符中的意义各不相同。 
   220                              <1> ;           ⑴ 在描述可执行段的描述符中，D位决定了指令使用的地址及操作数所默认的大小。
   221                              <1> ;		① D=1表示默认情况下指令使用32位地址及32位或8位操作数，这样的代码段也称为32位代码段；
   222                              <1> ;		② D=0 表示默认情况下，使用16位地址及16位或8位操作数，这样的代码段也称为16位代码段，它与80286兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认
   223                              <1> ;           ⑵ 在向下扩展数据段的描述符中，D位决定段的上部边界。
   224                              <1> ;		① D=1表示段的上部界限为4G；
   225                              <1> ;		② D=0表示段的上部界限为64K，这是为了与80286兼容。 
   226                              <1> ;           ⑶ 在描述由SS寄存器寻址的段描述符中，D位决定隐式的堆栈访问指令(如PUSH和POP指令)使用何种堆栈指针寄存器。
   227                              <1> ;		① D=1表示使用32位堆栈指针寄存器ESP；
   228                              <1> ;		② D=0表示使用16位堆栈指针寄存器SP，这与80286兼容。 
   229                              <1> ;
   230                              <1> ; (7) AVL:  软件可利用位。80386对该位的使用未左规定，Intel公司也保证今后开发生产的处理器只要与80386兼容，就不会对该位的使用做任何定义或规定。 
   231                              <1> ;
   232                              <1> 
   233                              <1> 
   234                              <1> ;----------------------------------------------------------------------------
   235                              <1> ; 描述符类型值说明
   236                              <1> ; 其中:
   237                              <1> ;       DA_  : Descriptor Attribute
   238                              <1> ;       D    : 数据段
   239                              <1> ;       C    : 代码段
   240                              <1> ;       S    : 系统段
   241                              <1> ;       R    : 只读
   242                              <1> ;       RW   : 读写
   243                              <1> ;       A    : 已访问
   244                              <1> ;       其它 : 可按照字面意思理解
   245                              <1> ;----------------------------------------------------------------------------
   246                              <1> DA_32		EQU	4000h	; 32 位段
   247                              <1> DA_LIMIT_4K	EQU	8000h	; 段界限粒度为 4K 字节
   248                              <1> 
   249                              <1> DA_DPL0		EQU	  00h	; DPL = 0
   250                              <1> DA_DPL1		EQU	  20h	; DPL = 1
   251                              <1> DA_DPL2		EQU	  40h	; DPL = 2
   252                              <1> DA_DPL3		EQU	  60h	; DPL = 3
   253                              <1> ;----------------------------------------------------------------------------
   254                              <1> ; 存储段描述符类型值说明
   255                              <1> ;----------------------------------------------------------------------------
   256                              <1> DA_DR		EQU	90h	; 存在的只读数据段类型值
   257                              <1> DA_DRW		EQU	92h	; 存在的可读写数据段属性值
   258                              <1> DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
   259                              <1> DA_C		EQU	98h	; 存在的只执行代码段属性值
   260                              <1> DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
   261                              <1> DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
   262                              <1> DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
   263                              <1> ;----------------------------------------------------------------------------
   264                              <1> ; 系统段描述符类型值说明
   265                              <1> ;----------------------------------------------------------------------------
   266                              <1> DA_LDT		EQU	  82h	; 局部描述符表段类型值
   267                              <1> DA_TaskGate	EQU	  85h	; 任务门类型值
   268                              <1> DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
   269                              <1> DA_386CGate	EQU	  8Ch	; 386 调用门类型值
   270                              <1> DA_386IGate	EQU	  8Eh	; 386 中断门类型值
   271                              <1> DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
   272                              <1> ;----------------------------------------------------------------------------
   273                              <1> 
   274                              <1> 
   275                              <1> ; 选择子图示:
   276                              <1> ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
   277                              <1> ;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   278                              <1> ;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
   279                              <1> ;         ┃                                 描述符索引                                 ┃ TI ┃   RPL    ┃
   280                              <1> ;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
   281                              <1> ;
   282                              <1> ; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
   283                              <1> ;
   284                              <1> ; TI(Table Indicator): 引用描述符表指示位
   285                              <1> ;	TI=0 指示从全局描述符表GDT中读取描述符；
   286                              <1> ;	TI=1 指示从局部描述符表LDT中读取描述符。
   287                              <1> ;
   288                              <1> 
   289                              <1> ;----------------------------------------------------------------------------
   290                              <1> ; 选择子类型值说明
   291                              <1> ; 其中:
   292                              <1> ;       SA_  : Selector Attribute
   293                              <1> 
   294                              <1> SA_RPL0		EQU	0	; ┓
   295                              <1> SA_RPL1		EQU	1	; ┣ RPL
   296                              <1> SA_RPL2		EQU	2	; ┃
   297                              <1> SA_RPL3		EQU	3	; ┛
   298                              <1> 
   299                              <1> SA_TIG		EQU	0	; ┓TI
   300                              <1> SA_TIL		EQU	4	; ┛
   301                              <1> ;----------------------------------------------------------------------------
   302                              <1> 
   303                              <1> 
   304                              <1> ;----------------------------------------------------------------------------
   305                              <1> ; 分页机制使用的常量说明
   306                              <1> ;----------------------------------------------------------------------------
   307                              <1> PG_P		EQU	1	; 页存在属性位
   308                              <1> PG_RWR		EQU	0	; R/W 属性位值, 读/执行
   309                              <1> PG_RWW		EQU	2	; R/W 属性位值, 读/写/执行
   310                              <1> PG_USS		EQU	0	; U/S 属性位值, 系统级
   311                              <1> PG_USU		EQU	4	; U/S 属性位值, 用户级
   312                              <1> ;----------------------------------------------------------------------------
   313                              <1> 
   314                              <1> 
   315                              <1> 
   316                              <1> 
   317                              <1> ; =========================================
   318                              <1> ; FLAGS - Intel 8086 Family Flags Register
   319                              <1> ; =========================================
   320                              <1> ;
   321                              <1> ;      |11|10|F|E|D|C|B|A|9|8|7|6|5|4|3|2|1|0|
   322                              <1> ;        |  | | | | | | | | | | | | | | | | '---  CF……Carry Flag
   323                              <1> ;        |  | | | | | | | | | | | | | | | '---  1
   324                              <1> ;        |  | | | | | | | | | | | | | | '---  PF……Parity Flag
   325                              <1> ;        |  | | | | | | | | | | | | | '---  0
   326                              <1> ;        |  | | | | | | | | | | | | '---  AF……Auxiliary Flag
   327                              <1> ;        |  | | | | | | | | | | | '---  0
   328                              <1> ;        |  | | | | | | | | | | '---  ZF……Zero Flag
   329                              <1> ;        |  | | | | | | | | | '---  SF……Sign Flag
   330                              <1> ;        |  | | | | | | | | '---  TF……Trap Flag  (Single Step)
   331                              <1> ;        |  | | | | | | | '---  IF……Interrupt Flag
   332                              <1> ;        |  | | | | | | '---  DF……Direction Flag
   333                              <1> ;        |  | | | | | '---  OF……Overflow flag
   334                              <1> ;        |  | | | '-----  IOPL……I/O Privilege Level  (286+ only)
   335                              <1> ;        |  | | '-----  NT……Nested Task Flag  (286+ only)
   336                              <1> ;        |  | '-----  0
   337                              <1> ;        |  '-----  RF……Resume Flag (386+ only)
   338                              <1> ;        '------  VM……Virtual Mode Flag (386+ only)
   339                              <1> ;
   340                              <1> ;        注: see   PUSHF  POPF  STI  CLI  STD  CLD
   341                              <1> ;
   342                              <1> 
   343                              <1> 
   344                              <1> ; 宏 ------------------------------------------------------------------------------------------------------
   345                              <1> ;
   346                              <1> ; 描述符
   347                              <1> ; usage: Descriptor Base, Limit, Attr
   348                              <1> ;        Base:  dd
   349                              <1> ;        Limit: dd (low 20 bits available)
   350                              <1> ;        Attr:  dw (lower 4 bits of higher byte are always 0)
   351                              <1> %macro Descriptor 3
   352                              <1> 	dw	%2 & 0FFFFh				             ; 段界限 1				(2 字节)
   353                              <1> 	dw	%1 & 0FFFFh				             ; 段基址 1				(2 字节)
   354                              <1> 	db	(%1 >> 16) & 0FFh			         ; 段基址 2				(1 字节)
   355                              <1> 	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	 ; 属性 1 + 段界限 2 + 属性 2		(2 字节)
   356                              <1> 	db	(%1 >> 24) & 0FFh			         ; 段基址 3				(1 字节)
   357                              <1> %endmacro ; 共 8 字节
   358                              <1> ;
   359                              <1> ; 门
   360                              <1> ; usage: Gate Selector, Offset, DCount, Attr
   361                              <1> ;        Selector:  dw
   362                              <1> ;        Offset:    dd
   363                              <1> ;        DCount:    db
   364                              <1> ;        Attr:      db
   365                              <1> %macro Gate 4
   366                              <1> 	dw	(%2 & 0FFFFh)				             ; 偏移 1				(2 字节)
   367                              <1> 	dw	%1					                     ; 选择子				(2 字节)
   368                              <1> 	dw	(%3 & 1Fh) | ((%4 << 8) & 0FF00h)	     ; 属性					(2 字节)
   369                              <1> 	dw	((%2 >> 16) & 0FFFFh)			         ; 偏移 2				(2 字节)
   370                              <1> %endmacro ; 共 8 字节
   371                              <1> ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   372                                  
   373                                  ; GDT ----------------------------------------------------------------------------------------
   374                                  ;                     段基址,      段界限,   属性                                 -
   375                                  GDT:     Descriptor        0,           0,   0                             ; 空描述符   -
   376                              <1> GDT: 
   377 0000003E 0000                <1>  dw %2 & 0FFFFh
   378 00000040 0000                <1>  dw %1 & 0FFFFh
   379 00000042 00                  <1>  db (%1 >> 16) & 0FFh
   380 00000043 0000                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   381 00000045 00                  <1>  db (%1 >> 24) & 0FFh
   382                                  FLAT_C:  Descriptor        0,     0fffffh,   DA_CR  | DA_32 | DA_LIMIT_4K ;|DA_DRW ; 0 ~ 4G     -
   383                              <1> FLAT_C: 
   384 00000046 FFFF                <1>  dw %2 & 0FFFFh
   385 00000048 0000                <1>  dw %1 & 0FFFFh
   386 0000004A 00                  <1>  db (%1 >> 16) & 0FFh
   387 0000004B 9ACF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   388 0000004D 00                  <1>  db (%1 >> 24) & 0FFh
   389                                  FLAT_RW: Descriptor        0,     0fffffh,   DA_DRW | DA_32 | DA_LIMIT_4K  ; 0 ~ 4G     -
   390                              <1> FLAT_RW: 
   391 0000004E FFFF                <1>  dw %2 & 0FFFFh
   392 00000050 0000                <1>  dw %1 & 0FFFFh
   393 00000052 00                  <1>  db (%1 >> 16) & 0FFh
   394 00000053 92CF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   395 00000055 00                  <1>  db (%1 >> 24) & 0FFh
   396                                  VIDEO:   Descriptor  0B8000h,      0ffffh,   DA_DRW ;| DA_DPL3              ; 显存首地址 -
   397                              <1> VIDEO: 
   398 00000056 FFFF                <1>  dw %2 & 0FFFFh
   399 00000058 0080                <1>  dw %1 & 0FFFFh
   400 0000005A 0B                  <1>  db (%1 >> 16) & 0FFh
   401 0000005B 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   402 0000005D 00                  <1>  db (%1 >> 24) & 0FFh
   403                                  ; GDT END-------------------------------------------------------------------------------------
   404                                  
   405                                  GdtLen  equ $ - GDT
   406 0000005E 1F00                    GdtPtr  dw GdtLen - 1                          ; 段界限
   407 00000060 [3E000000]                      dd GDT;+ BaseOfLoaderPhyAddr           ; 基地址
   408                                  
   409                                  
   410                                  ; GDT 选择子 ---------------------------------------------
   411                                  SelectorFlatC     equ   FLAT_C   - GDT             ;-
   412                                  SelectorFlatRW    equ   FLAT_RW  - GDT             ;-
   413                                  SelectorVideo     equ   VIDEO    - GDT ;+ SA_RPL3   ;-
   414                                  ; GDT 选择子 end------------------------------------------
   415                                  
   416                                  
   417                                  
   418                                  ; read sector 2 to memory 从cl/ch/dh/dl指向的扇区开始读取al个扇区的数据到es:bx指向的缓冲区
   419                                  read_fd:
   420 00000064 31C0                        xor ax, ax
   421 00000066 B012                        mov al, 12h   ; al=要读扇区数
   422 00000068 B500                        mov ch, 00000000b   ;ch=磁道号,CL - 位7、6是磁道号高2位
   423 0000006A B102                        mov cl, 00000010b   ;cl=起始扇区号,CL - 位5~0表示扇区号（从1开始）
   424                                                    ;mov cx, 0x0002 ;CH，10位磁道号低8位
   425                                                   ;CL - 位7、6是磁道号高2位
   426                                                   ;CL - 位5~0表示扇区号（从1开始）
   427                                                   ;本指令表示读取0号驱动器0号磁道第2号扇区
   428                                                   ;第1扇区就是boot扇区
   429 0000006C B600                        mov dh, 00h   ;dh=磁头号
   430 0000006E B200                        mov dl, 00h   ;dl=驱动器号 硬盘是0x80 软盘是0x0
   431 00000070 BB007E                      mov bx, 0x7e00 ;es:bx=数据缓冲区  放到7e00处
   432 00000073 B402                        mov ah, 02h
   433 00000075 CD13                        int 13h
   434 00000077 72EB                        jc read_fd
   435 00000079 C3                          ret
   436                                  ;end of read_fd
   437                                  
   438 0000007A 00<rept>                times 510-($-$$) db 0
   439 000001FE 55                      db 0x55
   440 000001FF AA                      db 0xAA
