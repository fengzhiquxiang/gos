     1                                  ; boot.asm
     2                                  org  07c00h
     3 00000000 EB26                    jmp start
     4                                  %include "pm.mac"
     5                              <1> 
     6                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     7                              <1> ;                               pm.inc
     8                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     9                              <1> ;                                                     Forrest Yu, 2005
    10                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    11                              <1> 
    12                              <1> 
    13                              <1> ; 描述符图示
    14                              <1> 
    15                              <1> ; 图示一
    16                              <1> ;
    17                              <1> ;  ------ ┏━━┳━━┓高地址
    18                              <1> ;         ┃ 7  ┃ 段 ┃
    19                              <1> ;         ┣━━┫    ┃
    20                              <1> ;                  基
    21                              <1> ;  字节 7 ┆    ┆    ┆
    22                              <1> ;                  址
    23                              <1> ;         ┣━━┫ ② ┃
    24                              <1> ;         ┃ 0  ┃    ┃
    25                              <1> ;  ------ ┣━━╋━━┫
    26                              <1> ;         ┃ 7  ┃ G  ┃
    27                              <1> ;         ┣━━╉──┨
    28                              <1> ;         ┃ 6  ┃ D  ┃
    29                              <1> ;         ┣━━╉──┨
    30                              <1> ;         ┃ 5  ┃ 0  ┃
    31                              <1> ;         ┣━━╉──┨
    32                              <1> ;         ┃ 4  ┃ AVL┃
    33                              <1> ;  字节 6 ┣━━╉──┨
    34                              <1> ;         ┃ 3  ┃    ┃
    35                              <1> ;         ┣━━┫ 段 ┃
    36                              <1> ;         ┃ 2  ┃ 界 ┃
    37                              <1> ;         ┣━━┫ 限 ┃
    38                              <1> ;         ┃ 1  ┃    ┃
    39                              <1> ;         ┣━━┫ ② ┃
    40                              <1> ;         ┃ 0  ┃    ┃
    41                              <1> ;  ------ ┣━━╋━━┫
    42                              <1> ;         ┃ 7  ┃ P  ┃
    43                              <1> ;         ┣━━╉──┨
    44                              <1> ;         ┃ 6  ┃    ┃
    45                              <1> ;         ┣━━┫ DPL┃
    46                              <1> ;         ┃ 5  ┃    ┃
    47                              <1> ;         ┣━━╉──┨
    48                              <1> ;         ┃ 4  ┃ S  ┃
    49                              <1> ;  字节 5 ┣━━╉──┨
    50                              <1> ;         ┃ 3  ┃    ┃
    51                              <1> ;         ┣━━┫ T  ┃
    52                              <1> ;         ┃ 2  ┃ Y  ┃
    53                              <1> ;         ┣━━┫ P  ┃
    54                              <1> ;         ┃ 1  ┃ E  ┃
    55                              <1> ;         ┣━━┫    ┃
    56                              <1> ;         ┃ 0  ┃    ┃
    57                              <1> ;  ------ ┣━━╋━━┫
    58                              <1> ;         ┃ 23 ┃    ┃
    59                              <1> ;         ┣━━┫    ┃
    60                              <1> ;         ┃ 22 ┃    ┃
    61                              <1> ;         ┣━━┫ 段 ┃
    62                              <1> ;
    63                              <1> ;   字节  ┆    ┆ 基 ┆
    64                              <1> ; 2, 3, 4
    65                              <1> ;         ┣━━┫ 址 ┃
    66                              <1> ;         ┃ 1  ┃ ① ┃
    67                              <1> ;         ┣━━┫    ┃
    68                              <1> ;         ┃ 0  ┃    ┃
    69                              <1> ;  ------ ┣━━╋━━┫
    70                              <1> ;         ┃ 15 ┃    ┃
    71                              <1> ;         ┣━━┫    ┃
    72                              <1> ;         ┃ 14 ┃    ┃
    73                              <1> ;         ┣━━┫ 段 ┃
    74                              <1> ;
    75                              <1> ; 字节 0,1┆    ┆ 界 ┆
    76                              <1> ;
    77                              <1> ;         ┣━━┫ 限 ┃
    78                              <1> ;         ┃ 1  ┃ ① ┃
    79                              <1> ;         ┣━━┫    ┃
    80                              <1> ;         ┃ 0  ┃    ┃
    81                              <1> ;  ------ ┗━━┻━━┛低地址
    82                              <1> ;
    83                              <1> 
    84                              <1> 
    85                              <1> ; 图示二
    86                              <1> 
    87                              <1> ; 高地址………………………………………………………………………低地址
    88                              <1> 
    89                              <1> ; |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0    |
    90                              <1> ; |7654321076543210765432107654321076543210765432107654321076543210|	<- 共 8 字节
    91                              <1> ; |--------========--------========--------========--------========|
    92                              <1> ; ┏━━━┳━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓
    93                              <1> ; ┃31..24┃   (见下图)   ┃     段基址(23..0)    ┃ 段界限(15..0)┃
    94                              <1> ; ┃      ┃              ┃                      ┃              ┃
    95                              <1> ; ┃ 基址2┃③│②│    ①┃基址1b│   基址1a     ┃    段界限1   ┃
    96                              <1> ; ┣━━━╋━━━┳━━━╋━━━━━━━━━━━╋━━━━━━━┫
    97                              <1> ; ┃   %6 ┃  %5  ┃  %4  ┃  %3  ┃     %2       ┃       %1     ┃
    98                              <1> ; ┗━━━┻━━━┻━━━┻━━━┻━━━━━━━┻━━━━━━━┛
    99                              <1> ;         │                \_________
   100                              <1> ;         │                          \__________________
   101                              <1> ;         │                                             \________________________________________________
   102                              <1> ;         │                                                                                              ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━
   103                              <1> ;         ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   104                              <1> ;         ┣━━╋━━╋━━╋━━╋━━┻━━┻━━┻━━╋━━╋━━┻━━╋━━╋━━┻━━┻━━┻━━┫
   105                              <1> ;         ┃ G  ┃ D  ┃ 0  ┃ AVL┃   段界限 2 (19..16)  ┃  P ┃   DPL    ┃ S  ┃       TYPE           ┃
   106                              <1> ;         ┣━━┻━━┻━━┻━━╋━━━━━━━━━━━╋━━┻━━━━━┻━━┻━━━━━━━━━━━┫
   107                              <1> ;         ┃      ③: 属性 2      ┃    ②: 段界限 2      ┃                   ①: 属性1                  ┃
   108                              <1> ;         ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━┛
   109                              <1> ;       高地址                                                                                          低地址
   110                              <1> ;
   111                              <1> ;
   112                              <1> 
   113                              <1> ; 说明:
   114                              <1> ;
   115                              <1> ; (1) P:    存在(Present)位。
   116                              <1> ;		P=1 表示描述符对地址转换是有效的，或者说该描述符所描述的段存在，即在内存中；
   117                              <1> ;		P=0 表示描述符对地址转换无效，即该段不存在。使用该描述符进行内存访问时会引起异常。
   118                              <1> ;
   119                              <1> ; (2) DPL:  表示描述符特权级(Descriptor Privilege level)，共2位。它规定了所描述段的特权级，用于特权检查，以决定对该段能否访问。 
   120                              <1> ;
   121                              <1> ; (3) S:   说明描述符的类型。
   122                              <1> ;		对于存储段描述符而言，S=1，以区别与系统段描述符和门描述符(S=0)。 
   123                              <1> ;
   124                              <1> ; (4) TYPE: 说明存储段描述符所描述的存储段的具体属性。
   125                              <1> ;
   126                              <1> ;		 
   127                              <1> ;	数据段类型	类型值		说明
   128                              <1> ;			----------------------------------
   129                              <1> ;			0		只读 
   130                              <1> ;			1		只读、已访问 
   131                              <1> ;			2		读/写 
   132                              <1> ;			3		读/写、已访问 
   133                              <1> ;			4		只读、向下扩展 
   134                              <1> ;			5		只读、向下扩展、已访问 
   135                              <1> ;			6		读/写、向下扩展 
   136                              <1> ;			7		读/写、向下扩展、已访问 
   137                              <1> ;
   138                              <1> ;		
   139                              <1> ;			类型值		说明
   140                              <1> ;	代码段类型	----------------------------------
   141                              <1> ;			8		只执行 
   142                              <1> ;			9		只执行、已访问 
   143                              <1> ;			A		执行/读 
   144                              <1> ;			B		执行/读、已访问 
   145                              <1> ;			C		只执行、一致码段 
   146                              <1> ;			D		只执行、一致码段、已访问 
   147                              <1> ;			E		执行/读、一致码段 
   148                              <1> ;			F		执行/读、一致码段、已访问 
   149                              <1> ;
   150                              <1> ;		
   151                              <1> ;	系统段类型	类型编码	说明
   152                              <1> ;			----------------------------------
   153                              <1> ;			0		<未定义>
   154                              <1> ;			1		可用286TSS
   155                              <1> ;			2		LDT
   156                              <1> ;			3		忙的286TSS
   157                              <1> ;			4		286调用门
   158                              <1> ;			5		任务门
   159                              <1> ;			6		286中断门
   160                              <1> ;			7		286陷阱门
   161                              <1> ;			8		未定义
   162                              <1> ;			9		可用386TSS
   163                              <1> ;			A		<未定义>
   164                              <1> ;			B		忙的386TSS
   165                              <1> ;			C		386调用门
   166                              <1> ;			D		<未定义>
   167                              <1> ;			E		386中断门
   168                              <1> ;			F		386陷阱门
   169                              <1> ;
   170                              <1> ; (5) G:    段界限粒度(Granularity)位。
   171                              <1> ;		G=0 表示界限粒度为字节；
   172                              <1> ;		G=1 表示界限粒度为4K 字节。
   173                              <1> ;           注意，界限粒度只对段界限有效，对段基地址无效，段基地址总是以字节为单位。 
   174                              <1> ;
   175                              <1> ; (6) D:    D位是一个很特殊的位，在描述可执行段、向下扩展数据段或由SS寄存器寻址的段(通常是堆栈段)的三种描述符中的意义各不相同。 
   176                              <1> ;           ⑴ 在描述可执行段的描述符中，D位决定了指令使用的地址及操作数所默认的大小。
   177                              <1> ;		① D=1表示默认情况下指令使用32位地址及32位或8位操作数，这样的代码段也称为32位代码段；
   178                              <1> ;		② D=0 表示默认情况下，使用16位地址及16位或8位操作数，这样的代码段也称为16位代码段，它与80286兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认
   179                              <1> ;           ⑵ 在向下扩展数据段的描述符中，D位决定段的上部边界。
   180                              <1> ;		① D=1表示段的上部界限为4G；
   181                              <1> ;		② D=0表示段的上部界限为64K，这是为了与80286兼容。 
   182                              <1> ;           ⑶ 在描述由SS寄存器寻址的段描述符中，D位决定隐式的堆栈访问指令(如PUSH和POP指令)使用何种堆栈指针寄存器。
   183                              <1> ;		① D=1表示使用32位堆栈指针寄存器ESP；
   184                              <1> ;		② D=0表示使用16位堆栈指针寄存器SP，这与80286兼容。 
   185                              <1> ;
   186                              <1> ; (7) AVL:  软件可利用位。80386对该位的使用未左规定，Intel公司也保证今后开发生产的处理器只要与80386兼容，就不会对该位的使用做任何定义或规定。 
   187                              <1> ;
   188                              <1> 
   189                              <1> 
   190                              <1> ;----------------------------------------------------------------------------
   191                              <1> ; 描述符类型值说明
   192                              <1> ; 其中:
   193                              <1> ;       DA_  : Descriptor Attribute
   194                              <1> ;       D    : 数据段
   195                              <1> ;       C    : 代码段
   196                              <1> ;       S    : 系统段
   197                              <1> ;       R    : 只读
   198                              <1> ;       RW   : 读写
   199                              <1> ;       A    : 已访问
   200                              <1> ;       其它 : 可按照字面意思理解
   201                              <1> ;----------------------------------------------------------------------------
   202                              <1> DA_32		EQU	4000h	; 32 位段
   203                              <1> DA_LIMIT_4K	EQU	8000h	; 段界限粒度为 4K 字节
   204                              <1> 
   205                              <1> DA_DPL0		EQU	  00h	; DPL = 0
   206                              <1> DA_DPL1		EQU	  20h	; DPL = 1
   207                              <1> DA_DPL2		EQU	  40h	; DPL = 2
   208                              <1> DA_DPL3		EQU	  60h	; DPL = 3
   209                              <1> ;----------------------------------------------------------------------------
   210                              <1> ; 存储段描述符类型值说明
   211                              <1> ;----------------------------------------------------------------------------
   212                              <1> DA_DR		EQU	90h	; 存在的只读数据段类型值
   213                              <1> DA_DRW		EQU	92h	; 存在的可读写数据段属性值
   214                              <1> DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
   215                              <1> DA_C		EQU	98h	; 存在的只执行代码段属性值
   216                              <1> DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
   217                              <1> DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
   218                              <1> DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
   219                              <1> ;----------------------------------------------------------------------------
   220                              <1> ; 系统段描述符类型值说明
   221                              <1> ;----------------------------------------------------------------------------
   222                              <1> DA_LDT		EQU	  82h	; 局部描述符表段类型值
   223                              <1> DA_TaskGate	EQU	  85h	; 任务门类型值
   224                              <1> DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
   225                              <1> DA_386CGate	EQU	  8Ch	; 386 调用门类型值
   226                              <1> DA_386IGate	EQU	  8Eh	; 386 中断门类型值
   227                              <1> DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
   228                              <1> ;----------------------------------------------------------------------------
   229                              <1> 
   230                              <1> 
   231                              <1> ; 选择子图示:
   232                              <1> ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
   233                              <1> ;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   234                              <1> ;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
   235                              <1> ;         ┃                                 描述符索引                                 ┃ TI ┃   RPL    ┃
   236                              <1> ;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
   237                              <1> ;
   238                              <1> ; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
   239                              <1> ;
   240                              <1> ; TI(Table Indicator): 引用描述符表指示位
   241                              <1> ;	TI=0 指示从全局描述符表GDT中读取描述符；
   242                              <1> ;	TI=1 指示从局部描述符表LDT中读取描述符。
   243                              <1> ;
   244                              <1> 
   245                              <1> ;----------------------------------------------------------------------------
   246                              <1> ; 选择子类型值说明
   247                              <1> ; 其中:
   248                              <1> ;       SA_  : Selector Attribute
   249                              <1> 
   250                              <1> SA_RPL0		EQU	0	; ┓
   251                              <1> SA_RPL1		EQU	1	; ┣ RPL
   252                              <1> SA_RPL2		EQU	2	; ┃
   253                              <1> SA_RPL3		EQU	3	; ┛
   254                              <1> 
   255                              <1> SA_TIG		EQU	0	; ┓TI
   256                              <1> SA_TIL		EQU	4	; ┛
   257                              <1> ;----------------------------------------------------------------------------
   258                              <1> 
   259                              <1> 
   260                              <1> ;----------------------------------------------------------------------------
   261                              <1> ; 分页机制使用的常量说明
   262                              <1> ;----------------------------------------------------------------------------
   263                              <1> PG_P		EQU	1	; 页存在属性位
   264                              <1> PG_RWR		EQU	0	; R/W 属性位值, 读/执行
   265                              <1> PG_RWW		EQU	2	; R/W 属性位值, 读/写/执行
   266                              <1> PG_USS		EQU	0	; U/S 属性位值, 系统级
   267                              <1> PG_USU		EQU	4	; U/S 属性位值, 用户级
   268                              <1> ;----------------------------------------------------------------------------
   269                              <1> 
   270                              <1> 
   271                              <1> 
   272                              <1> 
   273                              <1> ; =========================================
   274                              <1> ; FLAGS - Intel 8086 Family Flags Register
   275                              <1> ; =========================================
   276                              <1> ;
   277                              <1> ;      |11|10|F|E|D|C|B|A|9|8|7|6|5|4|3|2|1|0|
   278                              <1> ;        |  | | | | | | | | | | | | | | | | '---  CF……Carry Flag
   279                              <1> ;        |  | | | | | | | | | | | | | | | '---  1
   280                              <1> ;        |  | | | | | | | | | | | | | | '---  PF……Parity Flag
   281                              <1> ;        |  | | | | | | | | | | | | | '---  0
   282                              <1> ;        |  | | | | | | | | | | | | '---  AF……Auxiliary Flag
   283                              <1> ;        |  | | | | | | | | | | | '---  0
   284                              <1> ;        |  | | | | | | | | | | '---  ZF……Zero Flag
   285                              <1> ;        |  | | | | | | | | | '---  SF……Sign Flag
   286                              <1> ;        |  | | | | | | | | '---  TF……Trap Flag  (Single Step)
   287                              <1> ;        |  | | | | | | | '---  IF……Interrupt Flag
   288                              <1> ;        |  | | | | | | '---  DF……Direction Flag
   289                              <1> ;        |  | | | | | '---  OF……Overflow flag
   290                              <1> ;        |  | | | '-----  IOPL……I/O Privilege Level  (286+ only)
   291                              <1> ;        |  | | '-----  NT……Nested Task Flag  (286+ only)
   292                              <1> ;        |  | '-----  0
   293                              <1> ;        |  '-----  RF……Resume Flag (386+ only)
   294                              <1> ;        '------  VM……Virtual Mode Flag (386+ only)
   295                              <1> ;
   296                              <1> ;        注: see   PUSHF  POPF  STI  CLI  STD  CLD
   297                              <1> ;
   298                              <1> 
   299                              <1> 
   300                              <1> ; 宏 ------------------------------------------------------------------------------------------------------
   301                              <1> ;
   302                              <1> ; 描述符
   303                              <1> ; usage: Descriptor Base, Limit, Attr
   304                              <1> ;        Base:  dd
   305                              <1> ;        Limit: dd (low 20 bits available)
   306                              <1> ;        Attr:  dw (lower 4 bits of higher byte are always 0)
   307                              <1> %macro Descriptor 3
   308                              <1> 	dw	%2 & 0FFFFh				             ; 段界限 1				(2 字节)
   309                              <1> 	dw	%1 & 0FFFFh				             ; 段基址 1				(2 字节)
   310                              <1> 	db	(%1 >> 16) & 0FFh			         ; 段基址 2				(1 字节)
   311                              <1> 	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	 ; 属性 1 + 段界限 2 + 属性 2		(2 字节)
   312                              <1> 	db	(%1 >> 24) & 0FFh			         ; 段基址 3				(1 字节)
   313                              <1> %endmacro ; 共 8 字节
   314                              <1> ;
   315                              <1> ; 门
   316                              <1> ; usage: Gate Selector, Offset, DCount, Attr
   317                              <1> ;        Selector:  dw
   318                              <1> ;        Offset:    dd
   319                              <1> ;        DCount:    db
   320                              <1> ;        Attr:      db
   321                              <1> %macro Gate 4
   322                              <1> 	dw	(%2 & 0FFFFh)				             ; 偏移 1				(2 字节)
   323                              <1> 	dw	%1					                     ; 选择子				(2 字节)
   324                              <1> 	dw	(%3 & 1Fh) | ((%4 << 8) & 0FF00h)	     ; 属性					(2 字节)
   325                              <1> 	dw	((%2 >> 16) & 0FFFFh)			         ; 偏移 2				(2 字节)
   326                              <1> %endmacro ; 共 8 字节
   327                              <1> ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   328                                  
   329                                  BaseOfLoaderPhyAddr equ 0x07c00
   330                                  PM_START            equ 0x200
   331                                  
   332                                  ; GDT ----------------------------------------------------------------------------------------
   333                                  ;                          段基址,      段界限,   属性                                 -
   334                                  GDT:          Descriptor        0,           0,   0                             ; 空描述符   -
   335                              <1> GDT: 
   336 00000002 0000                <1>  dw %2 & 0FFFFh
   337 00000004 0000                <1>  dw %1 & 0FFFFh
   338 00000006 00                  <1>  db (%1 >> 16) & 0FFh
   339 00000007 0000                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   340 00000009 00                  <1>  db (%1 >> 24) & 0FFh
   341                                  DESC_FLAT_C:  Descriptor        0,     0fffffh,   DA_CR  | DA_32 | DA_LIMIT_4K ;|DA_DRW ; 0 ~ 4G     -
   342                              <1> DESC_FLAT_C: 
   343 0000000A FFFF                <1>  dw %2 & 0FFFFh
   344 0000000C 0000                <1>  dw %1 & 0FFFFh
   345 0000000E 00                  <1>  db (%1 >> 16) & 0FFh
   346 0000000F 9ACF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   347 00000011 00                  <1>  db (%1 >> 24) & 0FFh
   348                                  DESC_FLAT_RW: Descriptor        0,     0fffffh,   DA_DRW | DA_32 | DA_LIMIT_4K  ; 0 ~ 4G     -
   349                              <1> DESC_FLAT_RW: 
   350 00000012 FFFF                <1>  dw %2 & 0FFFFh
   351 00000014 0000                <1>  dw %1 & 0FFFFh
   352 00000016 00                  <1>  db (%1 >> 16) & 0FFh
   353 00000017 92CF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   354 00000019 00                  <1>  db (%1 >> 24) & 0FFh
   355                                  DESC_VIDEO:   Descriptor  0B8000h,      0ffffh,   DA_DRW ;| DA_DPL3              ; 显存首地址 -
   356                              <1> DESC_VIDEO: 
   357 0000001A FFFF                <1>  dw %2 & 0FFFFh
   358 0000001C 0080                <1>  dw %1 & 0FFFFh
   359 0000001E 0B                  <1>  db (%1 >> 16) & 0FFh
   360 0000001F 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   361 00000021 00                  <1>  db (%1 >> 24) & 0FFh
   362                                  ; GDT END-------------------------------------------------------------------------------------
   363                                  
   364                                  GdtLen      equ   $ - GDT
   365 00000022 1F00                    GdtPtr      dw GdtLen - 1                          ; 段界限
   366 00000024 [02000000]                          dd GDT;+ BaseOfLoaderPhyAddr           ; 基地址
   367                                  
   368                                  
   369                                  ; GDT 选择子 ---------------------------------------------
   370                                  SelectorFlatC     equ   DESC_FLAT_C   - GDT             ;-
   371                                  SelectorFlatRW    equ   DESC_FLAT_RW  - GDT             ;-
   372                                  SelectorVideo     equ   DESC_VIDEO    - GDT + SA_RPL3   ;-
   373                                  ; GDT 选择子 end------------------------------------------
   374                                  
   375                                  
   376                                  start:
   377 00000028 B80000                  mov ax, 0x0
   378 0000002B 8ED8                    mov ds, ax
   379 0000002D 8EC0                    mov es, ax 
   380 0000002F 8ED0                    mov ss, ax 
   381                                  
   382 00000031 B8007C                  mov ax, BaseOfLoaderPhyAddr
   383 00000034 89C4                    mov sp, ax   
   384                                  
   385                                  ; 清屏
   386 00000036 B80006                  mov   ax, 0600h      ; AH = 6,  AL = 0h
   387 00000039 BB0007                  mov   bx, 0700h      ; 黑底白字(BL = 07h)
   388 0000003C B90000                  mov   cx, 0       ; 左上角: (0, 0)
   389 0000003F BA4F18                  mov   dx, 0184fh     ; 右下角: (80, 50)
   390 00000042 CD10                    int   10h         ; int 10h
   391                                  
   392                                  ;设置显示模式
   393                                  ;mov ah,  00h       ;入口参数：AH＝00H
   394                                  ;mov al,  02h       ;AL＝ 显示器模式，见下表所示
   395                                                     ;  出口参数：无
   396                                                     ;  可用的显示模式如下所列：
   397                                                     ;  00H：40×25 16色 文本
   398                                                     ;  01H：40×25 16 色 文本
   399                                                     ;  02H：80×25 16色 文本
   400                                                     ;  03H: 80×25 16色 文本
   401                                                     ;  04H：320×200 4色
   402                                  ;int 10h
   403                                  
   404                                  ;获取当前显示模式
   405                                  ;mov ah,  0fh
   406                                  ;int 10h
   407                                  
   408                                  ;光标归位
   409                                  ;mov   bh, 00h      ; BH＝显示页码
   410                                  ;mov   dx, 0000h      ; DH＝行(Y坐标) DL＝列(X坐标)
   411                                  ;int   02h         ; int 10h
   412                                  
   413                                  ;使用BIOS的0x10中断向屏幕打印一个字符
   414                                  ;mov ah, 0x0e
   415                                  ;mov al, '!'
   416                                  ;int 0x10
   417                                  ;mov ah, 0x0e
   418                                  ;mov al, '?'
   419                                  ;int 0x10
   420                                  
   421                                  ;call display
   422                                  ;jmp $
   423                                  ;加载img里的kernel.bin 进内存
   424                                  
   425                                     ; reset floppy
   426                                     ; xor ah, ah  ; ah=00h      al=驱动器号（0表示A盘） 
   427                                     ; xor dl,  dl
   428                                     ; int 13h
   429                                  
   430 00000044 E86000                   call read_fd
   431                                  
   432                                  ;进入保护模式，执行kernel代码
   433                                        ; 1、初始化GDT描述符
   434                                        ; 2、加载gdtr
   435                                        ; 3、打开A20地址线
   436                                        ; 4、设置寄存器cr0的PE位为1，使之运行于保护模式
   437                                        ; 5、执行跳转指令，让系统进入保护模式
   438                                  
   439                                        ; 初始化 32 位代码段描述符
   440                                        ; xor eax, eax
   441                                        ; mov ax, cs
   442                                        ; shl eax, 4
   443                                        ; add eax, DESC_FLAT_C
   444                                        ; mov word [DESC_FLAT_C + 2], ax
   445                                        ; shr eax, 16
   446                                        ; mov byte [DESC_FLAT_C + 4], al
   447                                        ; mov byte [DESC_FLAT_C + 7], ah
   448                                  
   449                                  
   450                                        ; 下面准备跳入保护模式 -------------------------------------------
   451                                  
   452                                        ; 加载 GDTR
   453 00000047 0F0116[2200]                     lgdt  [GdtPtr]
   454                                  
   455                                        ; 关中断
   456 0000004C FA                               cli
   457                                  
   458                                        ; 打开地址线A20
   459 0000004D E492                             in al, 92h
   460 0000004F 0C02                             or al, 00000010b
   461 00000051 E692                             out   92h, al
   462                                  
   463                                        ; 准备切换到保护模式
   464 00000053 0F20C0                           mov   eax, cr0
   465 00000056 6683C801                         or eax, 1
   466 0000005A 0F22C0                           mov   cr0, eax
   467                                  
   468                                        ; 真正进入保护模式
   469 0000005D 66EA007E00000800                 jmp   dword SelectorFlatC:0x7e00
   470                                  
   471                                  
   472                                  hang:
   473 00000065 EBFE                       jmp hang
   474                                  
   475                                  display:
   476 00000067 B8[BD00]                   mov   ax, BootMessage
   477 0000006A 89C5                       mov   bp, ax                        ; ES:BP = 串地址
   478 0000006C B91B00                     mov   cx, BootMessageLength         ; CX为字符串长度
   479 0000006F B80113                     mov   ax, 01301h     ; AH = 13,BIOS的10H中断的13号中断用于显示字符串  
   480                                                          ;AL = 01h AL＝显示方式
   481                                                                      ;如果AL＝0，表示目标字符串仅仅包含字符，属性在BL中包含，不移动光标
   482                                                                      ;如果AL＝1，表示目标字符串仅仅包含字符，属性在BL中包含，移动光标
   483                                                                      ;如果AL＝2，表示目标字符串包含字符和属性，不移动光标
   484                                                                      ;如果AL＝3，表示目标字符串包含字符和属性，移动光标
   485 00000072 B700                       mov   bh, 0h      ; 页号为0(BH = 0) 黑底红字(BL = 0Ch,高亮)
   486 00000074 B370                       mov   bl, 01110000b   ;如果AL的BIT1为0或1，则BL表示显示属性。属性为：
   487                                                        ;｜BIT7｜BIT6｜BIT5｜BIT4｜BIT3｜BIT2｜BIT1｜BIT0｜ BL
   488                                                        ;  BIT7：背景是否闪烁。0不闪烁，1闪烁
   489                                                        ;  BIT6~BIT4为背景色，分别为RGB，000为黑色，111为白色
   490                                                        ;  BIT3为1，则前景色加亮，为0则不加亮
   491                                                        ;  BIT2－BIT0为前景色，意义同背景色
   492 00000076 B600                       mov   dh, 0        ; DH表示在第几行显示（0为第一行）
   493 00000078 B200                       mov   dl, 0       ;DL表示在第几列显示（0为第一列）
   494 0000007A CD10                       int   10h         ; int 10h
   495 0000007C C3                         ret
   496                                  ;end of display
   497                                  
   498                                  ;; in:  ax: LBA address, starts from 0
   499                                      ;;    es:bx address for reading sector
   500                                  read_sect:
   501 0000007D 50                          push ax
   502 0000007E 51                          push cx
   503 0000007F 52                          push dx
   504 00000080 53                          push bx
   505                                  
   506 00000081 89F0                        mov  ax,  si   
   507 00000083 31D2                        xor  dx,  dx
   508 00000085 BB1200                      mov  bx,  18  ; 18 sectors per track 
   509                                            ; for floppy disk
   510 00000088 F7F3                        div   bx
   511 0000008A 42                          inc   dx
   512 0000008B 88D1                        mov   cl, dl  ; cl=sector number
   513 0000008D 31D2                        xor   dx,  dx
   514 0000008F BB0200                      mov   bx,  2  ; 2 headers per track 
   515                                            ; for floppy disk
   516 00000092 F7F3                        div   bx
   517                                  
   518 00000094 88D6                        mov   dh,  dl   ; head
   519 00000096 30D2                        xor   dl,  dl   ; driver
   520 00000098 88C5                        mov   ch,  al   ; cylinder
   521 0000009A 5B                          pop   bx        ; save to es:bx
   522                                  rp_read:
   523 0000009B B001                        mov  al, 0x1    ;  read 1 sector
   524 0000009D B402                        mov  ah, 0x2
   525 0000009F CD13                        int 0x13
   526 000000A1 72F8                        jc  rp_read
   527 000000A3 5A                          pop   dx
   528 000000A4 59                          pop   cx
   529 000000A5 58                          pop   ax
   530 000000A6 C3                          ret
   531                                  ; end of read_sect
   532                                  
   533                                  ; read sector 2 to memory 从cl/ch/dh/dl指向的扇区开始读取al个扇区的数据到es:bx指向的缓冲区
   534                                  read_fd:
   535 000000A7 31C0                        xor ax, ax
   536 000000A9 B012                        mov al, 12h   ; al=要读扇区数
   537 000000AB B500                        mov ch, 00000000b   ;ch=磁道号,CL - 位7、6是磁道号高2位
   538 000000AD B102                        mov cl, 00000010b   ;cl=起始扇区号,CL - 位5~0表示扇区号（从1开始）
   539                                                    ;mov cx, 0x0002 ;CH，10位磁道号低8位
   540                                                   ;CL - 位7、6是磁道号高2位
   541                                                   ;CL - 位5~0表示扇区号（从1开始）
   542                                                   ;本指令表示读取0号驱动器0号磁道第2号扇区
   543                                                   ;第1扇区就是boot扇区
   544 000000AF B600                        mov dh, 00h   ;dh=磁头号
   545 000000B1 B280                        mov dl, 80h   ;dl=驱动器号 硬盘是0x80 软盘是0x0
   546 000000B3 BB007E                      mov bx, 0x7e00 ;es:bx=数据缓冲区  放到7e00处
   547 000000B6 B402                        mov ah, 02h
   548 000000B8 CD13                        int 13h
   549 000000BA 72EB                        jc read_fd
   550 000000BC C3                          ret
   551                                  ;end of read_fd
   552                                  
   553 000000BD 48656C6C6F20676F73-     BootMessage db 'Hello gos!!!!!!!!!!!!!!!!!!'
   554 000000C6 212121212121212121-
   555 000000CF 212121212121212121 
   556                                  BootMessageLength equ $-BootMessage
   557                                  
   558 000000D8 00<rept>                times 510-($-$$) db 0
   559 000001FE 55                      db 0x55
   560 000001FF AA                      db 0xAA
