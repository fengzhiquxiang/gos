     1                                  %include "pm.mac"
     2                              <1> 
     3                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     4                              <1> ;                               pm.inc
     5                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     6                              <1> ;                                                     Forrest Yu, 2005
     7                              <1> ; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     8                              <1> 
     9                              <1> 
    10                              <1> ; 描述符图示
    11                              <1> 
    12                              <1> ; 图示一
    13                              <1> ;
    14                              <1> ;  ------ ┏━━┳━━┓高地址
    15                              <1> ;         ┃ 7  ┃ 段 ┃
    16                              <1> ;         ┣━━┫    ┃
    17                              <1> ;                  基
    18                              <1> ;  字节 7 ┆    ┆    ┆
    19                              <1> ;                  址
    20                              <1> ;         ┣━━┫ ② ┃
    21                              <1> ;         ┃ 0  ┃    ┃
    22                              <1> ;  ------ ┣━━╋━━┫
    23                              <1> ;         ┃ 7  ┃ G  ┃
    24                              <1> ;         ┣━━╉──┨
    25                              <1> ;         ┃ 6  ┃ D  ┃
    26                              <1> ;         ┣━━╉──┨
    27                              <1> ;         ┃ 5  ┃ 0  ┃
    28                              <1> ;         ┣━━╉──┨
    29                              <1> ;         ┃ 4  ┃ AVL┃
    30                              <1> ;  字节 6 ┣━━╉──┨
    31                              <1> ;         ┃ 3  ┃    ┃
    32                              <1> ;         ┣━━┫ 段 ┃
    33                              <1> ;         ┃ 2  ┃ 界 ┃
    34                              <1> ;         ┣━━┫ 限 ┃
    35                              <1> ;         ┃ 1  ┃    ┃
    36                              <1> ;         ┣━━┫ ② ┃
    37                              <1> ;         ┃ 0  ┃    ┃
    38                              <1> ;  ------ ┣━━╋━━┫
    39                              <1> ;         ┃ 7  ┃ P  ┃
    40                              <1> ;         ┣━━╉──┨
    41                              <1> ;         ┃ 6  ┃    ┃
    42                              <1> ;         ┣━━┫ DPL┃
    43                              <1> ;         ┃ 5  ┃    ┃
    44                              <1> ;         ┣━━╉──┨
    45                              <1> ;         ┃ 4  ┃ S  ┃
    46                              <1> ;  字节 5 ┣━━╉──┨
    47                              <1> ;         ┃ 3  ┃    ┃
    48                              <1> ;         ┣━━┫ T  ┃
    49                              <1> ;         ┃ 2  ┃ Y  ┃
    50                              <1> ;         ┣━━┫ P  ┃
    51                              <1> ;         ┃ 1  ┃ E  ┃
    52                              <1> ;         ┣━━┫    ┃
    53                              <1> ;         ┃ 0  ┃    ┃
    54                              <1> ;  ------ ┣━━╋━━┫
    55                              <1> ;         ┃ 23 ┃    ┃
    56                              <1> ;         ┣━━┫    ┃
    57                              <1> ;         ┃ 22 ┃    ┃
    58                              <1> ;         ┣━━┫ 段 ┃
    59                              <1> ;
    60                              <1> ;   字节  ┆    ┆ 基 ┆
    61                              <1> ; 2, 3, 4
    62                              <1> ;         ┣━━┫ 址 ┃
    63                              <1> ;         ┃ 1  ┃ ① ┃
    64                              <1> ;         ┣━━┫    ┃
    65                              <1> ;         ┃ 0  ┃    ┃
    66                              <1> ;  ------ ┣━━╋━━┫
    67                              <1> ;         ┃ 15 ┃    ┃
    68                              <1> ;         ┣━━┫    ┃
    69                              <1> ;         ┃ 14 ┃    ┃
    70                              <1> ;         ┣━━┫ 段 ┃
    71                              <1> ;
    72                              <1> ; 字节 0,1┆    ┆ 界 ┆
    73                              <1> ;
    74                              <1> ;         ┣━━┫ 限 ┃
    75                              <1> ;         ┃ 1  ┃ ① ┃
    76                              <1> ;         ┣━━┫    ┃
    77                              <1> ;         ┃ 0  ┃    ┃
    78                              <1> ;  ------ ┗━━┻━━┛低地址
    79                              <1> ;
    80                              <1> 
    81                              <1> 
    82                              <1> ; 图示二
    83                              <1> 
    84                              <1> ; 高地址………………………………………………………………………低地址
    85                              <1> 
    86                              <1> ; |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0    |
    87                              <1> ; |7654321076543210765432107654321076543210765432107654321076543210|	<- 共 8 字节
    88                              <1> ; |--------========--------========--------========--------========|
    89                              <1> ; ┏━━━┳━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓
    90                              <1> ; ┃31..24┃   (见下图)   ┃     段基址(23..0)    ┃ 段界限(15..0)┃
    91                              <1> ; ┃      ┃              ┃                      ┃              ┃
    92                              <1> ; ┃ 基址2┃③│②│    ①┃基址1b│   基址1a     ┃    段界限1   ┃
    93                              <1> ; ┣━━━╋━━━┳━━━╋━━━━━━━━━━━╋━━━━━━━┫
    94                              <1> ; ┃   %6 ┃  %5  ┃  %4  ┃  %3  ┃     %2       ┃       %1     ┃
    95                              <1> ; ┗━━━┻━━━┻━━━┻━━━┻━━━━━━━┻━━━━━━━┛
    96                              <1> ;         │                \_________
    97                              <1> ;         │                          \__________________
    98                              <1> ;         │                                             \________________________________________________
    99                              <1> ;         │                                                                                              ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━
   100                              <1> ;         ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   101                              <1> ;         ┣━━╋━━╋━━╋━━╋━━┻━━┻━━┻━━╋━━╋━━┻━━╋━━╋━━┻━━┻━━┻━━┫
   102                              <1> ;         ┃ G  ┃ D  ┃ 0  ┃ AVL┃   段界限 2 (19..16)  ┃  P ┃   DPL    ┃ S  ┃       TYPE           ┃
   103                              <1> ;         ┣━━┻━━┻━━┻━━╋━━━━━━━━━━━╋━━┻━━━━━┻━━┻━━━━━━━━━━━┫
   104                              <1> ;         ┃      ③: 属性 2      ┃    ②: 段界限 2      ┃                   ①: 属性1                  ┃
   105                              <1> ;         ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━┛
   106                              <1> ;       高地址                                                                                          低地址
   107                              <1> ;
   108                              <1> ;
   109                              <1> 
   110                              <1> ; 说明:
   111                              <1> ;
   112                              <1> ; (1) P:    存在(Present)位。
   113                              <1> ;		P=1 表示描述符对地址转换是有效的，或者说该描述符所描述的段存在，即在内存中；
   114                              <1> ;		P=0 表示描述符对地址转换无效，即该段不存在。使用该描述符进行内存访问时会引起异常。
   115                              <1> ;
   116                              <1> ; (2) DPL:  表示描述符特权级(Descriptor Privilege level)，共2位。它规定了所描述段的特权级，用于特权检查，以决定对该段能否访问。 
   117                              <1> ;
   118                              <1> ; (3) S:   说明描述符的类型。
   119                              <1> ;		对于存储段描述符而言，S=1，以区别与系统段描述符和门描述符(S=0)。 
   120                              <1> ;
   121                              <1> ; (4) TYPE: 说明存储段描述符所描述的存储段的具体属性。
   122                              <1> ;
   123                              <1> ;		 
   124                              <1> ;	数据段类型	类型值		说明
   125                              <1> ;			----------------------------------
   126                              <1> ;			0		只读 
   127                              <1> ;			1		只读、已访问 
   128                              <1> ;			2		读/写 
   129                              <1> ;			3		读/写、已访问 
   130                              <1> ;			4		只读、向下扩展 
   131                              <1> ;			5		只读、向下扩展、已访问 
   132                              <1> ;			6		读/写、向下扩展 
   133                              <1> ;			7		读/写、向下扩展、已访问 
   134                              <1> ;
   135                              <1> ;		
   136                              <1> ;			类型值		说明
   137                              <1> ;	代码段类型	----------------------------------
   138                              <1> ;			8		只执行 
   139                              <1> ;			9		只执行、已访问 
   140                              <1> ;			A		执行/读 
   141                              <1> ;			B		执行/读、已访问 
   142                              <1> ;			C		只执行、一致码段 
   143                              <1> ;			D		只执行、一致码段、已访问 
   144                              <1> ;			E		执行/读、一致码段 
   145                              <1> ;			F		执行/读、一致码段、已访问 
   146                              <1> ;
   147                              <1> ;		
   148                              <1> ;	系统段类型	类型编码	说明
   149                              <1> ;			----------------------------------
   150                              <1> ;			0		<未定义>
   151                              <1> ;			1		可用286TSS
   152                              <1> ;			2		LDT
   153                              <1> ;			3		忙的286TSS
   154                              <1> ;			4		286调用门
   155                              <1> ;			5		任务门
   156                              <1> ;			6		286中断门
   157                              <1> ;			7		286陷阱门
   158                              <1> ;			8		未定义
   159                              <1> ;			9		可用386TSS
   160                              <1> ;			A		<未定义>
   161                              <1> ;			B		忙的386TSS
   162                              <1> ;			C		386调用门
   163                              <1> ;			D		<未定义>
   164                              <1> ;			E		386中断门
   165                              <1> ;			F		386陷阱门
   166                              <1> ;
   167                              <1> ; (5) G:    段界限粒度(Granularity)位。
   168                              <1> ;		G=0 表示界限粒度为字节；
   169                              <1> ;		G=1 表示界限粒度为4K 字节。
   170                              <1> ;           注意，界限粒度只对段界限有效，对段基地址无效，段基地址总是以字节为单位。 
   171                              <1> ;
   172                              <1> ; (6) D:    D位是一个很特殊的位，在描述可执行段、向下扩展数据段或由SS寄存器寻址的段(通常是堆栈段)的三种描述符中的意义各不相同。 
   173                              <1> ;           ⑴ 在描述可执行段的描述符中，D位决定了指令使用的地址及操作数所默认的大小。
   174                              <1> ;		① D=1表示默认情况下指令使用32位地址及32位或8位操作数，这样的代码段也称为32位代码段；
   175                              <1> ;		② D=0 表示默认情况下，使用16位地址及16位或8位操作数，这样的代码段也称为16位代码段，它与80286兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认
   176                              <1> ;           ⑵ 在向下扩展数据段的描述符中，D位决定段的上部边界。
   177                              <1> ;		① D=1表示段的上部界限为4G；
   178                              <1> ;		② D=0表示段的上部界限为64K，这是为了与80286兼容。 
   179                              <1> ;           ⑶ 在描述由SS寄存器寻址的段描述符中，D位决定隐式的堆栈访问指令(如PUSH和POP指令)使用何种堆栈指针寄存器。
   180                              <1> ;		① D=1表示使用32位堆栈指针寄存器ESP；
   181                              <1> ;		② D=0表示使用16位堆栈指针寄存器SP，这与80286兼容。 
   182                              <1> ;
   183                              <1> ; (7) AVL:  软件可利用位。80386对该位的使用未左规定，Intel公司也保证今后开发生产的处理器只要与80386兼容，就不会对该位的使用做任何定义或规定。 
   184                              <1> ;
   185                              <1> 
   186                              <1> 
   187                              <1> ;----------------------------------------------------------------------------
   188                              <1> ; 描述符类型值说明
   189                              <1> ; 其中:
   190                              <1> ;       DA_  : Descriptor Attribute
   191                              <1> ;       D    : 数据段
   192                              <1> ;       C    : 代码段
   193                              <1> ;       S    : 系统段
   194                              <1> ;       R    : 只读
   195                              <1> ;       RW   : 读写
   196                              <1> ;       A    : 已访问
   197                              <1> ;       其它 : 可按照字面意思理解
   198                              <1> ;----------------------------------------------------------------------------
   199                              <1> DA_32		EQU	4000h	; 32 位段
   200                              <1> DA_LIMIT_4K	EQU	8000h	; 段界限粒度为 4K 字节
   201                              <1> 
   202                              <1> DA_DPL0		EQU	  00h	; DPL = 0
   203                              <1> DA_DPL1		EQU	  20h	; DPL = 1
   204                              <1> DA_DPL2		EQU	  40h	; DPL = 2
   205                              <1> DA_DPL3		EQU	  60h	; DPL = 3
   206                              <1> ;----------------------------------------------------------------------------
   207                              <1> ; 存储段描述符类型值说明
   208                              <1> ;----------------------------------------------------------------------------
   209                              <1> DA_DR		EQU	90h	; 存在的只读数据段类型值
   210                              <1> DA_DRW		EQU	92h	; 存在的可读写数据段属性值
   211                              <1> DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
   212                              <1> DA_C		EQU	98h	; 存在的只执行代码段属性值
   213                              <1> DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
   214                              <1> DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
   215                              <1> DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
   216                              <1> ;----------------------------------------------------------------------------
   217                              <1> ; 系统段描述符类型值说明
   218                              <1> ;----------------------------------------------------------------------------
   219                              <1> DA_LDT		EQU	  82h	; 局部描述符表段类型值
   220                              <1> DA_TaskGate	EQU	  85h	; 任务门类型值
   221                              <1> DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
   222                              <1> DA_386CGate	EQU	  8Ch	; 386 调用门类型值
   223                              <1> DA_386IGate	EQU	  8Eh	; 386 中断门类型值
   224                              <1> DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
   225                              <1> ;----------------------------------------------------------------------------
   226                              <1> 
   227                              <1> 
   228                              <1> ; 选择子图示:
   229                              <1> ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
   230                              <1> ;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   231                              <1> ;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
   232                              <1> ;         ┃                                 描述符索引                                 ┃ TI ┃   RPL    ┃
   233                              <1> ;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
   234                              <1> ;
   235                              <1> ; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
   236                              <1> ;
   237                              <1> ; TI(Table Indicator): 引用描述符表指示位
   238                              <1> ;	TI=0 指示从全局描述符表GDT中读取描述符；
   239                              <1> ;	TI=1 指示从局部描述符表LDT中读取描述符。
   240                              <1> ;
   241                              <1> 
   242                              <1> ;----------------------------------------------------------------------------
   243                              <1> ; 选择子类型值说明
   244                              <1> ; 其中:
   245                              <1> ;       SA_  : Selector Attribute
   246                              <1> 
   247                              <1> SA_RPL0		EQU	0	; ┓
   248                              <1> SA_RPL1		EQU	1	; ┣ RPL
   249                              <1> SA_RPL2		EQU	2	; ┃
   250                              <1> SA_RPL3		EQU	3	; ┛
   251                              <1> 
   252                              <1> SA_TIG		EQU	0	; ┓TI
   253                              <1> SA_TIL		EQU	4	; ┛
   254                              <1> ;----------------------------------------------------------------------------
   255                              <1> 
   256                              <1> 
   257                              <1> ;----------------------------------------------------------------------------
   258                              <1> ; 分页机制使用的常量说明
   259                              <1> ;----------------------------------------------------------------------------
   260                              <1> PG_P		EQU	1	; 页存在属性位
   261                              <1> PG_RWR		EQU	0	; R/W 属性位值, 读/执行
   262                              <1> PG_RWW		EQU	2	; R/W 属性位值, 读/写/执行
   263                              <1> PG_USS		EQU	0	; U/S 属性位值, 系统级
   264                              <1> PG_USU		EQU	4	; U/S 属性位值, 用户级
   265                              <1> ;----------------------------------------------------------------------------
   266                              <1> 
   267                              <1> 
   268                              <1> 
   269                              <1> 
   270                              <1> ; =========================================
   271                              <1> ; FLAGS - Intel 8086 Family Flags Register
   272                              <1> ; =========================================
   273                              <1> ;
   274                              <1> ;      |11|10|F|E|D|C|B|A|9|8|7|6|5|4|3|2|1|0|
   275                              <1> ;        |  | | | | | | | | | | | | | | | | '---  CF……Carry Flag
   276                              <1> ;        |  | | | | | | | | | | | | | | | '---  1
   277                              <1> ;        |  | | | | | | | | | | | | | | '---  PF……Parity Flag
   278                              <1> ;        |  | | | | | | | | | | | | | '---  0
   279                              <1> ;        |  | | | | | | | | | | | | '---  AF……Auxiliary Flag
   280                              <1> ;        |  | | | | | | | | | | | '---  0
   281                              <1> ;        |  | | | | | | | | | | '---  ZF……Zero Flag
   282                              <1> ;        |  | | | | | | | | | '---  SF……Sign Flag
   283                              <1> ;        |  | | | | | | | | '---  TF……Trap Flag  (Single Step)
   284                              <1> ;        |  | | | | | | | '---  IF……Interrupt Flag
   285                              <1> ;        |  | | | | | | '---  DF……Direction Flag
   286                              <1> ;        |  | | | | | '---  OF……Overflow flag
   287                              <1> ;        |  | | | '-----  IOPL……I/O Privilege Level  (286+ only)
   288                              <1> ;        |  | | '-----  NT……Nested Task Flag  (286+ only)
   289                              <1> ;        |  | '-----  0
   290                              <1> ;        |  '-----  RF……Resume Flag (386+ only)
   291                              <1> ;        '------  VM……Virtual Mode Flag (386+ only)
   292                              <1> ;
   293                              <1> ;        注: see   PUSHF  POPF  STI  CLI  STD  CLD
   294                              <1> ;
   295                              <1> 
   296                              <1> 
   297                              <1> ; 宏 ------------------------------------------------------------------------------------------------------
   298                              <1> ;
   299                              <1> ; 描述符
   300                              <1> ; usage: Descriptor Base, Limit, Attr
   301                              <1> ;        Base:  dd
   302                              <1> ;        Limit: dd (low 20 bits available)
   303                              <1> ;        Attr:  dw (lower 4 bits of higher byte are always 0)
   304                              <1> %macro Descriptor 3
   305                              <1> 	dw	%2 & 0FFFFh				             ; 段界限 1				(2 字节)
   306                              <1> 	dw	%1 & 0FFFFh				             ; 段基址 1				(2 字节)
   307                              <1> 	db	(%1 >> 16) & 0FFh			         ; 段基址 2				(1 字节)
   308                              <1> 	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	 ; 属性 1 + 段界限 2 + 属性 2		(2 字节)
   309                              <1> 	db	(%1 >> 24) & 0FFh			         ; 段基址 3				(1 字节)
   310                              <1> %endmacro ; 共 8 字节
   311                              <1> ;
   312                              <1> ; 门
   313                              <1> ; usage: Gate Selector, Offset, DCount, Attr
   314                              <1> ;        Selector:  dw
   315                              <1> ;        Offset:    dd
   316                              <1> ;        DCount:    db
   317                              <1> ;        Attr:      db
   318                              <1> %macro Gate 4
   319                              <1> 	dw	(%2 & 0FFFFh)				             ; 偏移 1				(2 字节)
   320                              <1> 	dw	%1					                     ; 选择子				(2 字节)
   321                              <1> 	dw	(%3 & 1Fh) | ((%4 << 8) & 0FF00h)	     ; 属性					(2 字节)
   322                              <1> 	dw	((%2 >> 16) & 0FFFFh)			         ; 偏移 2				(2 字节)
   323                              <1> %endmacro ; 共 8 字节
   324                              <1> ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   325                                  
   326                                  %define INIT_ADDR 0x7E00
   327                                  %define COLOR_Cyan 0x03 ; Cyan
   328                                  %define COLOR_RED 0x04 ; red
   329                                  %define ROWS 80
   330                                  %define ROWZ 2*ROWS
   331                                  %define COLUMNS 25
   332                                  
   333                                  
   334                                  [BITS 32]
   335                                  
   336                                  [SECTION .text]
   337                                      extern c_start             ;out
   338                                      extern print_a
   339                                      extern print_string_with_color  ;  void print_string_with_color(unsigned char * string, unsigned char color);
   340                                  
   341                                      global kernel_entry     ;entry
   342                                      global display_x    ;define vari
   343                                      global display_y    ;define vari
   344                                  
   345                                      kernel_entry:
   346                                          ;register initia
   347 00000000 B810000000                      mov eax,  0x10   
   348 00000005 8ED8                            mov ds,   ax     
   349 00000007 8EC0                            mov es,   ax    
   350 00000009 8EE0                            mov fs ,  ax 
   351 0000000B 8ED0                            mov ss,   ax    
   352 0000000D B818000000                      mov eax,  0x18  
   353 00000012 8EE8                            mov gs,   ax       
   354 00000014 BC00000A00                      mov esp,  0xA0000  
   355                                  
   356 00000019 E8(00000000)                    call c_start
   357                                          
   358                                          
   359 0000001E E8(00000000)                    call print_a
   360                                  
   361                                          ;  void print_string_with_color(unsigned char * string, unsigned char color);
   362 00000023 6A04                            push COLOR_RED
   363 00000025 68[5B000000]                    push string1
   364 0000002A E8(00000000)                    call print_string_with_color
   365 0000002F 83C408                          add esp, 0x08
   366                                          ;  void print_string_with_color(unsigned char * string, unsigned char color);
   367 00000032 6A03                            push COLOR_Cyan
   368 00000034 68[5B000000]                    push string1
   369 00000039 E8(00000000)                    call print_string_with_color
   370 0000003E 83C408                          add esp, 0x08
   371                                          ;  void print_string_with_color(unsigned char * string, unsigned char color);
   372 00000041 6A04                            push COLOR_RED
   373 00000043 68[5B000000]                    push string1
   374 00000048 E8(00000000)                    call print_string_with_color
   375 0000004D 83C408                          add esp, 0x08
   376                                          
   377 00000050 F4                              hlt
   378                                      here:		
   379 00000051 EBFE                            jmp here
   380                                  
   381 00000053 00000000                display_x: dd 0
   382 00000057 00000000                display_y: dd 0
   383                                  
   384                                  ;global hello
   385 0000005B 0A6964747474747474-     string1: db 0x0a,"idtttttttttttttttttttt!!!!ppppppppppppppppppppppppppp",0x0a,0x00
   386 00000064 747474747474747474-
   387 0000006D 747474747421212121-
   388 00000076 707070707070707070-
   389 0000007F 707070707070707070-
   390 00000088 707070707070707070-
   391 00000091 0A00               
   392                                  string1_addr equ string1-$$+INIT_ADDR
